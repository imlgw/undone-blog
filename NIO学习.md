---
title:
  NIOå­¦ä¹ 
tags:
  [Socket]
categories: 
	[ç½‘ç»œç¼–ç¨‹]
cover: http://static.imlgw.top///20190420/zjSkt65Oip3h.png?imageslim
---

### éžé˜»å¡žIO

ðŸ”¸ NIO å…¨ç§°ï¼šNon-blocking I/O

ðŸ”¸ JDK 1.4 å¼•å…¥çš„å…¨æ–°çš„è¾“å…¥è¾“å‡ºæ ‡å‡†åº“NIOï¼Œä¹Ÿå«New I/O

ðŸ”¸ åœ¨æ ‡å‡†çš„Javaä»£ç ä¸­æä¾›äº†é«˜é€Ÿçš„ï¼Œå¯ä¼¸ç¼©çš„ï¼Œé¢å‘å—çš„ï¼Œéžé˜»å¡žè‰²çš„IOæ“ä½œ

`CSDN` çœ‹åˆ°çš„ä¸€ä¸ªå¾ˆé€šä¿—çš„è§£é‡Šï¼š

ä¼ ç»Ÿçš„socket IOä¸­ï¼Œéœ€è¦ä¸ºæ¯ä¸ªè¿žæŽ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå½“å¹¶å‘çš„è¿žæŽ¥æ•°é‡éžå¸¸å·¨å¤§æ—¶ï¼Œçº¿ç¨‹æ‰€å ç”¨çš„æ ˆå†…å­˜å’ŒCPUçº¿ç¨‹åˆ‡æ¢çš„å¼€é”€å°†éžå¸¸å·¨å¤§ã€‚ä½¿ç”¨NIOï¼Œä¸å†éœ€è¦ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºå•ç‹¬çš„çº¿ç¨‹ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªå«æœ‰é™æ•°é‡çº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œç”šè‡³ä¸€ä¸ªçº¿ç¨‹æ¥ä¸ºä»»æ„æ•°é‡çš„è¿žæŽ¥æœåŠ¡ã€‚ç”±äºŽçº¿ç¨‹æ•°é‡å°äºŽè¿žæŽ¥æ•°é‡ï¼Œæ‰€ä»¥æ¯ä¸ªçº¿ç¨‹è¿›è¡ŒIOæ“ä½œæ—¶å°±ä¸èƒ½é˜»å¡žï¼Œå¦‚æžœé˜»å¡žçš„è¯ï¼Œæœ‰äº›è¿žæŽ¥å°±å¾—ä¸åˆ°å¤„ç†ï¼ŒNIOæä¾›äº†è¿™ç§éžé˜»å¡žçš„èƒ½åŠ›ã€‚

å°é‡çš„çº¿ç¨‹å¦‚ä½•åŒæ—¶ä¸ºå¤§é‡è¿žæŽ¥æœåŠ¡å‘¢ï¼Œç­”æ¡ˆå°±æ˜¯å°±ç»ªé€‰æ‹©ã€‚è¿™å°±å¥½æ¯”åˆ°é¤åŽ…åƒé¥­ï¼Œæ¯æ¥ä¸€æ¡Œå®¢äººï¼Œéƒ½æœ‰ä¸€ä¸ªæœåŠ¡å‘˜ä¸“é—¨ä¸ºä½ æœåŠ¡ï¼Œä»Žä½ åˆ°é¤åŽ…åˆ°ç»“å¸èµ°äººï¼Œè¿™æ ·æ–¹å¼çš„å¥½å¤„æ˜¯æœåŠ¡è´¨é‡å¥½ï¼Œä¸€å¯¹ä¸€çš„æœåŠ¡ï¼ŒVIPå•Šï¼Œå¯æ˜¯ç¼ºç‚¹ä¹Ÿå¾ˆæ˜Žæ˜¾ï¼Œæˆæœ¬é«˜ï¼Œå¦‚æžœé¤åŽ…ç”Ÿæ„å¥½ï¼ŒåŒæ—¶æ¥100æ¡Œå®¢äººï¼Œå°±éœ€è¦100ä¸ªæœåŠ¡å‘˜ï¼Œé‚£è€æ¿å‘å·¥èµ„çš„æ—¶å€™å¾—å¿ƒç—›æ­»äº†ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„ä¸€ä¸ªè¿žæŽ¥ä¸€ä¸ªçº¿ç¨‹çš„æ–¹å¼ã€‚

è€æ¿æ˜¯ä»€ä¹ˆäººå•Šï¼Œç²¾ç€å‘¢ã€‚è¿™è€æ¿å°±å¾—æ‰æ‘¸æ€Žä¹ˆèƒ½ç”¨10ä¸ªæœåŠ¡å‘˜åŒæ—¶ä¸º100æ¡Œå®¢äººæœåŠ¡å‘¢ï¼Œè€æ¿å°±å‘çŽ°ï¼ŒæœåŠ¡å‘˜åœ¨ä¸ºå®¢äººæœåŠ¡çš„è¿‡ç¨‹ä¸­å¹¶ä¸æ˜¯ä¸€ç›´éƒ½å¿™ç€ï¼Œå®¢äººç‚¹å®Œèœï¼Œä¸Šå®Œèœï¼Œåƒç€çš„è¿™æ®µæ—¶é—´ï¼ŒæœåŠ¡å‘˜å°±é—²ä¸‹æ¥äº†ï¼Œå¯æ˜¯è¿™ä¸ªæœåŠ¡å‘˜è¿˜æ˜¯è¢«è¿™æ¡Œå®¢äººå ç”¨ç€ï¼Œä¸èƒ½ä¸ºåˆ«çš„å®¢äººæœåŠ¡ï¼Œç”¨åŽä¸ºé¢†å¯¼çš„è¯è¯´ï¼Œå°±æ˜¯å·¥ä½œä¸é¥±æ»¡ã€‚é‚£æ€Žä¹ˆæŠŠè¿™æ®µé—²ç€çš„æ—¶é—´åˆ©ç”¨èµ·æ¥å‘¢ã€‚è¿™é¤åŽ…è€æ¿å°±æƒ³äº†ä¸€ä¸ªåŠžæ³•ï¼Œè®©ä¸€ä¸ªæœåŠ¡å‘˜ï¼ˆå‰å°ï¼‰ä¸“é—¨è´Ÿè´£æ”¶é›†å®¢äººçš„éœ€æ±‚ï¼Œç™»è®°ä¸‹æ¥ï¼Œæ¯”å¦‚æœ‰å®¢äººè¿›æ¥äº†ã€å®¢äººç‚¹èœäº†ï¼Œå®¢äººè¦ç»“å¸äº†ï¼Œéƒ½å…ˆè®°å½•ä¸‹æ¥æŒ‰é¡ºåºæŽ’å¥½ã€‚æ¯ä¸ªæœåŠ¡å‘˜åˆ°è¿™é‡Œé¢†ä¸€ä¸ªéœ€æ±‚ï¼Œæ¯”å¦‚ç‚¹èœï¼Œå°±æ‹¿ç€èœå•å¸®å®¢äººç‚¹èœåŽ»äº†ã€‚ç‚¹å¥½èœä»¥åŽï¼ŒæœåŠ¡å‘˜é©¬ä¸Šå›žæ¥ï¼Œé¢†å–ä¸‹ä¸€ä¸ªéœ€æ±‚ï¼Œç»§ç»­ä¸ºåˆ«äººå®¢äººæœåŠ¡åŽ»äº†ã€‚è¿™ç§æ–¹å¼æœåŠ¡è´¨é‡å°±ä¸å¦‚ä¸€å¯¹ä¸€çš„æœåŠ¡äº†ï¼Œå½“å®¢äººæ•°æ®å¾ˆå¤šçš„æ—¶å€™å¯èƒ½éœ€è¦ç­‰å¾…ã€‚ä½†å¥½å¤„ä¹Ÿå¾ˆæ˜Žæ˜¾ï¼Œç”±äºŽåœ¨å®¢äººæ­£åƒé¥­ç€çš„æ—¶å€™æœåŠ¡å‘˜ä¸ç”¨é—²ç€äº†ï¼ŒæœåŠ¡å‘˜è¿™ä¸ªæ—¶é—´å†…å¯ä»¥ä¸ºå…¶ä»–å®¢äººæœåŠ¡äº†ï¼ŒåŽŸæ¥10ä¸ªæœåŠ¡å‘˜æœ€å¤šåŒæ—¶ä¸º10æ¡Œå®¢äººæœåŠ¡ï¼ŒçŽ°åœ¨å¯èƒ½ä¸º50æ¡Œï¼Œ60å®¢äººæœåŠ¡äº†ã€‚

è¿™ç§æœåŠ¡æ–¹å¼è·Ÿä¼ ç»Ÿçš„åŒºåˆ«æœ‰ä¸¤ä¸ªï¼š

1ã€å¢žåŠ äº†ä¸€ä¸ªè§’è‰²ï¼Œè¦æœ‰ä¸€ä¸ªä¸“é—¨è´Ÿè´£æ”¶é›†å®¢äººéœ€æ±‚çš„äººã€‚NIOé‡Œå¯¹åº”çš„å°±æ˜¯Selectorã€‚

2ã€ç”±é˜»å¡žæœåŠ¡æ–¹å¼æ”¹ä¸ºéžé˜»å¡žæœåŠ¡äº†ï¼Œå®¢äººåƒç€çš„æ—¶å€™æœåŠ¡å‘˜ä¸ç”¨ä¸€ç›´ä¾¯åœ¨å®¢äººæ—è¾¹äº†ã€‚ä¼ ç»Ÿçš„IOæ“ä½œï¼Œæ¯”å¦‚read()ï¼Œå½“æ²¡æœ‰æ•°æ®å¯è¯»çš„æ—¶å€™ï¼Œçº¿ç¨‹ä¸€ç›´é˜»å¡žè¢«å ç”¨ï¼Œç›´åˆ°æ•°æ®åˆ°æ¥ã€‚NIOä¸­æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œread()ä¼šç«‹å³è¿”å›ž0ï¼Œçº¿ç¨‹ä¸ä¼šé˜»å¡žã€‚

NIOä¸­ï¼Œå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªè¿žæŽ¥åŽï¼Œå…ˆè¦å°†è¿žæŽ¥æ³¨å†Œåˆ°Selectorï¼Œç›¸å½“äºŽå®¢äººè¿›å…¥é¤åŽ…åŽï¼Œå‘Šè¯‰å‰å°ä½ è¦ç”¨é¤ï¼Œå‰å°ä¼šå‘Šè¯‰ä½ ä½ çš„æ¡Œå·æ˜¯å‡ å·ï¼Œç„¶åŽä½ å°±å¯èƒ½åˆ°é‚£å¼ æ¡Œå­åä¸‹äº†ï¼ŒSelectionKeyå°±æ˜¯æ¡Œå·ã€‚å½“æŸä¸€æ¡Œéœ€è¦æœåŠ¡æ—¶ï¼Œå‰å°å°±è®°å½•å“ªä¸€æ¡Œéœ€è¦ä»€ä¹ˆæœåŠ¡ï¼Œæ¯”å¦‚1å·æ¡Œè¦ç‚¹èœï¼Œ2å·æ¡Œè¦ç»“å¸ï¼ŒæœåŠ¡å‘˜ä»Žå‰å°å–ä¸€æ¡è®°å½•ï¼Œæ ¹æ®è®°å½•æä¾›æœåŠ¡ï¼Œå®Œäº†å†æ¥å–ä¸‹ä¸€æ¡ã€‚è¿™æ ·æœåŠ¡çš„æ—¶é—´å°±è¢«æœ€æœ‰æ•ˆçš„åˆ©ç”¨èµ·æ¥äº†ã€‚

### NIO Family

ðŸ”¹ Buffer ç¼“å†²åŒº: ç”¨äºŽæ•°æ®å¤„ç†çš„åŸºç¡€å•å…ƒï¼Œå®¢æˆ·ç«¯å‘é€ä¸ŽæŽ¥æ”¶éƒ½éœ€è¦ç»è¿‡Bufferè½¬å‘

- åŒ…æ‹¬: ByteBufferï¼ŒCharBufferï¼ŒShortBufferï¼ŒIntBufferï¼ŒLongBufferï¼ŒFloatBufferï¼ŒDoubleBuffer
- å†™æ•°æ®æ—¶å…ˆå†™åˆ° Buffer --> Channel ï¼Œè¯»åˆ™ç›¸å
- ä¸ºNIOå—çŠ¶æ“ä½œæä¾›åŸºç¡€ï¼Œæ•°æ®éƒ½æŒ‰"å—"è¿›è¡Œä¼ è¾“ï¼Œä¸€ä¸ªBufferä»£è¡¨ä¸€"å—"æ•°æ®

ðŸ”¹ Channel é€šé“: ç±»ä¼¼äºŽæµï¼Œä½†ä¸åŒäºŽ I/O Streamï¼Œæµå…·æœ‰ç‹¬å æ€§å’Œå•å‘æ€§ï¼Œé€šé“åˆ™åå‘äºŽæ•°æ®çš„æµé€šå¤šæ ·æ€§

- å¯ä»¥åŒé€šé“ä¸­èŽ·å–æ•°æ®ä¹Ÿå¯è¾“å‡ºæ•°æ®åˆ°é€šé“ï¼ŒæŒ‰"å—"Buffer è¿›è¡Œ
- å¯å¹¶å‘å¯å¼‚æ­¥è¯»å†™æ•°æ®ï¼Œä½†æ˜¯è¯»å†™æ“ä½œæ˜¯ç‹¬å çš„
- è¯»æ•°æ®æ—¶è¯»å–åˆ°Bufferï¼Œå†™æ•°æ®å¿…é¡»é€šè¿‡Bufferå†™æ•°æ®
- åŒ…æ‹¬: FileChannelï¼ŒSocketChannelï¼ŒDatagramChannelç­‰

ðŸ”¹ Selectors é€‰æ‹©å™¨ : å¤„ç†å®¢æˆ·ç«¯æ‰€æœ‰äº‹ä»¶çš„åˆ†å‘å™¨

ðŸ”¹ Charset å­—ç¬¦ç¼–ç : åŠ å¯†è§£å¯† åŽŸç”Ÿæ”¯æŒçš„ï¼Œæ•°æ®é€šé“çº§åˆ«çš„æ•°æ®å¤„ç†æ–¹å¼ï¼Œå¯ä»¥ç”¨äºŽæ•°æ®ä¼ è¾“çº§åˆ«çš„æ•°æ®åŠ å¯†è§£å¯†æ“ä½œ

### NIO å¸¸è§API

![mark](http://static.imlgw.top/image/20190719/kPNTwrb6KKlN.png?imageslim)

#### Selectoræ³¨å†Œäº‹ä»¶

ðŸ”¸ `SelectionKey.OP_CONNNECT` è¿žæŽ¥å°±ç»ª

ðŸ”¸ `SelectionKey.OP_ACCEPT` æŽ¥å—å°±ç»ª

ðŸ”¸ `SelectionKey.OP_READ` è¯»å°±ç»ª

ðŸ”¸ `SelectionKey.OP_WRITE` å†™å°±ç»ª

#### Selectorä½¿ç”¨æµç¨‹

ðŸ”¸ `open()` å¼€å¯ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œå¯ä»¥ç»™é€‰æ‹©å™¨æ³¨å†Œéœ€è¦å…³æ³¨çš„äº‹ä»¶

ðŸ”¸ `register()` å°†ä¸€ä¸ªChannel æ³¨å†Œåˆ°é€‰æ‹©å™¨ï¼Œå½“é€‰æ‹©å™¨è§¦å‘å¯¹åº”å…³æ³¨äº‹ä»¶æ—¶å›žè°ƒåˆ°Channelä¸­ï¼Œå¤„ç†ç›¸å…³æ•°æ®

ðŸ”¸`select()/selectNow()`å½“å‰å°±ç»ªäº‹ä»¶çš„æ•°é‡ï¼Œé˜»å¡žæ–¹æ³•ï¼Œå¯ä»¥è¢«wakeUpå”¤é†’ï¼Œæ•°é‡ä¸º0

ðŸ”¸ `selectedKeys()` å¾—åˆ°çš„å°±ç»ªçŠ¶æ€çš„äº‹ä»¶é›†åˆ

- Interesté›†åˆï¼šæ‰€æœ‰æ³¨å†Œçš„é›†åˆ
- Readyé›†åˆï¼šå·²ç»å°±ç»ªçš„é›†åˆ
- Channelé€šé“
- Selector é€‰æ‹©å™¨
- obj é™„åŠ å€¼

ðŸ”¸ `wakeUp()` å”¤é†’ä¸€ä¸ªå¤„äºŽ`select`çŠ¶æ€çš„é€‰æ‹©å™¨ï¼Œå°±ç®—æ²¡æœ‰å°±ç»ªçš„Channel ä¹Ÿä¼šè¿”å›žï¼Œåªä¸è¿‡ä¸ºç©º

ðŸ”¸ `close()` å…³é—­ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œæ³¨é”€æ‰€æœ‰çš„å…³æ³¨çš„äº‹ä»¶

#### Selectoræ³¨æ„äº‹é¡¹

ðŸ”¸ æ³¨å†Œåˆ°é€‰æ‹©å™¨çš„é€šé“å¿…é¡»ä¸ºéžé˜»å¡žçŠ¶æ€

ðŸ”¸ `FileChannel` ä¸èƒ½ç”¨äºŽ`Selector`ï¼Œå› ä¸º`FileChannel` ä¸èƒ½åˆ‡æ¢ä¸ºéžé˜»å¡žæ¨¡å¼ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨é€šé“çš„æ–¹å¼æ“ä½œæ–‡ä»¶(ä»¥`å—çŠ¶`çš„æ–¹å¼åŽ»å’Œç£ç›˜äº¤äº’)ï¼Œ`SocketChannel`æ˜¯å¯ä»¥ç”¨äºŽ`Selector`çš„ã€‚

### NIOé‡å†™æœåŠ¡å™¨

### ByteBuffer

NIO Familyé‡Œé¢å¾ˆé‡è¦çš„ä¸€ä¸ªæˆå‘˜

- **PUTæ“ä½œ**

```java
	final int nextPutIndex() {                          // package-private
        if (position >= limit)
            throw new BufferOverflowException();
        return position++;
    }

    final int nextPutIndex(int nb) {                    // package-private
        if (limit - position < nb)
            throw new BufferOverflowException();
        int p = position;
        position += nb;
        return p;
    }
```

![mark](http://static.imlgw.top/image/20190719/TTrpBiyaRjsl.png?imageslim)

- **GETæ“ä½œ**

```java
    final int nextGetIndex() {                          // package-private
        if (position >= limit)
            throw new BufferUnderflowException();
        return position++;
    }

    final int nextGetIndex(int nb) {                    // package-private
        if (limit - position < nb)
            throw new BufferUnderflowException();
        int p = position;
        position += nb;
        return p;
    }
```

![mark](http://static.imlgw.top/image/20190719/qzE4xducQ4hm.png?imageslim)

- **clearæ“ä½œ**

```java
public final Buffer clear() {
    position = 0;
    limit = capacity;
    mark = -1;
    return this;
}
```
![mark](http://static.imlgw.top/image/20190719/cg4YkHcz6jTh.png?imageslim)



- **flipæ“ä½œ**

```java
    public final Buffer flip() {
        limit = position;
        position = 0;
        mark = -1;
        return this;
    }
```

![mark](http://static.imlgw.top/image/20190719/atyDWnqwPTo9.png?imageslim)

- è¯»å†™æ¨¡å¼

![mark](http://static.imlgw.top/image/20190719/Q0pBAplAU1L1.png?imageslim)

### å°Bug

![mark](http://static.imlgw.top/image/20190719/VKoYWGpkl5uG.png?imageslim)

æ¢è¡Œç¬¦çš„é—®é¢˜ï¼ŒreadLineå®žé™…ä¸Šæ˜¯